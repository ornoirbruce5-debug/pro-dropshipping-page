<!doctype html>
<html lang="rw">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Boutique Smart ‚Äî Landing Page</title>
  <meta name="description" content="Boutique smart: chatbot, stock, jokes, voice, image gen, maps, contact & WhatsApp support." />

  <!-- Basic styles, responsive layout, dark mode toggle, animated reveals -->
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#06b6d4; --glass: rgba(255,255,255,0.04);
      --maxw:1100px;
      --radius:12px;
      color-scheme: dark;
    }
    [data-theme="light"]{
      --bg:#f7fafc; --card:#ffffff; --muted:#475569; --accent:#0ea5a4; --glass: rgba(0,0,0,0.04);
      color-scheme: light;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:linear-gradient(180deg,#071226 0%, var(--bg) 100%); color:#e6eef6; -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale; line-height:1.45; scroll-behavior:smooth;
    }
    .container{max-width:var(--maxw); margin:0 auto; padding:20px;}
    header{position:fixed; left:0; right:0; top:12px; display:flex; align-items:center; justify-content:space-between; padding:8px 20px; z-index:60}
    .brand{display:flex; gap:12px; align-items:center}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:700}
    nav{display:flex;gap:12px;align-items:center}
    a.navlink{color:var(--muted);text-decoration:none;padding:8px;border-radius:8px}
    a.navlink:focus,a.navlink:hover{color:var(--accent);outline: none; box-shadow:0 0 0 3px rgba(6,182,212,0.12)}
    .toggle{background:var(--card); padding:6px;border-radius:8px;cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
    /* full-screen hero with video/fallback */
    .hero{
      min-height:100vh; display:grid; place-items:center; position:relative; overflow:hidden;
      border-bottom:1px solid rgba(255,255,255,0.03);
    }
    .bgmedia{position:absolute;inset:0;z-index:0;display:block;object-fit:cover;width:100%;height:100%}
    .bg-fallback{position:absolute;inset:0;background:url('https://images.unsplash.com/photo-1526178612303-7a7a9b3a3f7a?q=80&w=1600&auto=format&fit=crop') center/cover no-repeat;filter:brightness(.45);z-index:0}
    .hero-inner{position:relative;z-index:2;text-align:center;padding:48px 16px}
    .title{font-size:clamp(28px,6vw,48px);margin:6px 0;color:#fff;font-weight:800;letter-spacing:-0.02em}
    .subtitle{color:var(--muted);font-size:clamp(14px,2.5vw,18px);margin-bottom:18px}
    .cta{background:linear-gradient(90deg,var(--accent),#7c3aed); border:none;color:#041024;padding:12px 18px;border-radius:12px;font-weight:700;cursor:pointer}
    .cta:focus{outline:none; box-shadow:0 6px 20px rgba(7,128,161,0.18)}
    /* layout sections */
    section{padding:72px 0}
    .grid{display:grid;gap:20px;grid-template-columns:1fr 420px}
    @media(max-width:880px){ .grid{grid-template-columns:1fr} header{padding:8px 12px} .container{padding:12px} }
    /* stock table */
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); padding:18px; border-radius:var(--radius); box-shadow:0 6px 30px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03)}
    .stock-search{display:flex;gap:8px;margin-bottom:12px}
    .search{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .stock-table{width:100%;border-collapse:collapse}
    .stock-table th, .stock-table td{padding:10px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03)}
    .product-img{width:64px;height:64px;border-radius:8px;object-fit:cover}
    /* testimonials, jokes */
    .testi{display:flex;flex-direction:column;gap:12px}
    .testi-item{display:flex;gap:12px;align-items:flex-start}
    .avatar{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#ffb86b,#ff7ab6);display:inline-flex;align-items:center;justify-content:center;font-weight:700}
    .rating{color:#ffd166}
    /* chatbot */
    .chat-wrapper{display:flex;flex-direction:column;height:520px}
    .chat-window{flex:1;overflow:auto;padding:14px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02)}
    .message{display:inline-block;max-width:82%;padding:10px 12px;border-radius:12px;margin:8px 0;line-height:1.3}
    .user-msg{background:#06384a;color:#dff8ff;border-bottom-left-radius:4px;align-self:flex-end}
    .bot-msg{background:rgba(255,255,255,0.03);color:var(--muted);border-bottom-right-radius:4px}
    .chat-controls{display:flex;gap:8px;margin-top:10px}
    .chat-input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent}
    .voice-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:10px;cursor:pointer}
    /* map embed */
    .map{height:260px;border-radius:10px;overflow:hidden}
    /* footer */
    footer{padding:28px 0;border-top:1px solid rgba(255,255,255,0.03);margin-top:40px}
    .socials{display:flex;gap:12px;align-items:center}
    .qr{width:88px;height:88px;border-radius:8px;background:#071226;display:grid;place-items:center}
    /* animations */
    .reveal{opacity:0;transform:translateY(14px);transition:opacity .7s ease, transform .7s cubic-bezier(.2,.9,.2,1)}
    .reveal.active{opacity:1;transform:none}
    .fade-in{animation:fadeIn .9s both}
    @keyframes fadeIn{from{opacity:0; transform:translateY(12px)} to{opacity:1; transform:none}}
    /* small helpers */
    .muted{color:var(--muted)}
    .flex{display:flex;gap:12px;align-items:center}
    button:disabled{opacity:.5;cursor:not-allowed}
    /* accessible focus outlines */
    :focus{outline: 3px solid rgba(6,182,212,0.12); outline-offset:3px}
  </style>
</head>
<body>

  <!-- Header with brand and simple nav; includes dark mode toggle -->
  <header>
    <div class="brand container" style="max-width:none">
      <div class="logo" aria-hidden="true">B</div>
      <div>
        <strong>Boutique Smart</strong><br /><span class="muted" style="font-size:12px">Gihosha Gisandema</span>
      </div>
    </div>
    <nav>
      <a class="navlink" href="#stock">Stock</a>
      <a class="navlink" href="#chat">Chatbot</a>
      <a class="navlink" href="#contact">Contact</a>
      <button class="toggle" id="themeToggle" title="Toggle dark mode">üåô</button>
    </nav>
  </header>

  <!-- HERO SECTION
       - video background with fallback image
       - audio greeting in French plays on entry (muted autoplay rules handled)
       - CTA pre-fills contact subject
  -->
  <main>
    <section class="hero" id="home" aria-label="Hero section">
      <!-- video background; plays muted by default; fallback image layer in case video fails -->
      <video class="bgmedia" id="bgVideo" autoplay muted loop playsinline aria-hidden="true">
        <source src="https://cdn.coverr.co/videos/coverr-fashion-model-1595?token=eyJhbGciOiJI" type="video/mp4">
      </video>
      <div class="bg-fallback" aria-hidden="true"></div>

      <div class="hero-inner container reveal">
        <h1 class="title">Boutique Smart ‚Äî Imyenda, Inyongera, Serivisi</h1>
        <p class="subtitle">Dufasha abakiriya kubona ibicuruzwa byiza, kugura vuba kandi binyuze mu ijwi na chatbot ifite ubushobozi</p>

        <!-- CTA button; prefill subject in contact form via anchor param -->
        <div style="display:flex;gap:12px;justify-content:center;align-items:center;margin-top:16px">
          <a href="#contact?subject=Gushaka%20ibiciro%20bihanitse" class="cta" id="ctaPrimary">Dushorere kugiciro gito</a>
          <button class="cta" id="openChat" style="background:#0ea5a4;color:#022">Vugana natwe</button>
        </div>
        <!-- hidden audio greeting (French) that will be triggered once user interacts or allowed -->
        <audio id="greetingAudio" preload="auto">
          <source src="" type="audio/mpeg">
        </audio>
      </div>
    </section>

    <div class="container">
      <!-- STOCK SECTION
           - loads products from embedded JSON
           - live search
           - animated entry for items
      -->
      <section id="stock" class="reveal" aria-label="Stock section">
        <h2>Stock y'ibicuruzwa</h2>
        <p class="muted">Shakisha ibicuruzwa, urebe igiciro, ndetse ubaze chatbot niba bihari</p>

        <div class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="stock-search" style="width:70%">
              <input id="searchInput" class="search" placeholder="Shakisha ibicuruzwa..." aria-label="Shakisha ibicuruzwa" />
              <select id="filterCat" class="search" style="width:160px">
                <option value="">Icyiciro cyose</option>
                <option value="imyenda">Imyenda</option>
                <option value="inkweto">Inkweto</option>
                <option value="ubwiza">Ubwiza</option>
              </select>
            </div>
            <div class="muted">Ibisigaye: <span id="stockCount">0</span></div>
          </div>

          <div style="overflow:auto;margin-top:12px">
            <table class="stock-table" aria-live="polite" id="stockTable">
              <thead>
                <tr>
                  <th>Image</th>
                  <th>Izina / Ibisobanuro</th>
                  <th>Igiciro</th>
                  <th>Ububiko</th>
                </tr>
              </thead>
              <tbody id="stockBody">
                <!-- Rows inserted by JS from embedded JSON -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <hr style="border:none;height:24px"/>

      <!-- FEEDBACK SECTION: testimonials with emojis and ratings -->
      <section id="feedback" class="reveal">
        <h2>Ibitekerezo by'abakiriya</h2>
        <div class="card testi" style="margin-top:12px">
          <div class="testi-item">
            <div class="avatar">AB</div>
            <div>
              <strong>Aline B.</strong> <div class="rating">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
              <div class="muted">Imyenda yanjye yageze vuba kandi ifite ubuziranenge üòä</div>
            </div>
          </div>
          <div class="testi-item">
            <div class="avatar">MR</div>
            <div>
              <strong>Martin R.</strong> <div class="rating">‚≠ê‚≠ê‚≠ê‚≠ê</div>
              <div class="muted">Serivisi nziza, ubufasha bwa WhatsApp bwarushijeho gutuma ngura byoroshye üëç</div>
            </div>
          </div>
        </div>
      </section>

      <hr style="border:none;height:24px"/>

      <!-- DAILY JOKE SPINNER
           - jokes in Kirundi rotated daily using local date and stored to avoid repeats
           - TTS reads joke in Kinyarwanda on button click
      -->
      <section id="jokes" class="reveal">
        <h2>Joke ya buri munsi (Ikirundi)</h2>
        <div class="card" style="display:flex;gap:12px;flex-direction:column">
          <div id="jokeText" style="font-size:18px;color:var(--muted)">Gutoranya...</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="newJoke" class="cta" style="background:#7c3aed">Spin Joke</button>
            <button id="speakJoke" class="cta" style="background:#06b6d4;color:#022">Soma mu ijwi</button>
            <div class="muted" style="margin-left:auto">Ububiko: <span id="jokeUsedCount">0</span></div>
          </div>
        </div>
      </section>

      <hr style="border:none;height:24px"/>

      <!-- CHATBOT SECTION
           - Puter.js style chatbot logic implemented below
           - supports speech recognition, TTS (Kinyarwanda and Kiswahili), image generation button (placeholder), emoji injection
      -->
      <section id="chat" class="reveal">
        <h2>Chatbot y'ubucuruzi</h2>
        <p class="muted">Vuga cyangwa andika ikibazo; chatbot izasubiza, izavuga mu Kinyarwanda cyangwa Kiswahili, kandi izashushanya amafoto ashingiye ku bisobanuro</p>

        <div class="card" style="display:flex;gap:12px;flex-direction:column">
          <div class="grid" style="grid-template-columns:1fr 360px">
            <div style="display:flex;flex-direction:column;gap:8px">
              <div class="chat-wrapper">
                <div id="chatWindow" class="chat-window" role="log" aria-live="polite" tabindex="0">
                  <!-- messages go here -->
                </div>

                <div class="chat-controls">
                  <input id="chatInput" class="chat-input" placeholder="Andika cyangwa kanda icon y'ijwi..." aria-label="Chat input" />
                  <button id="voiceBtn" class="voice-btn" title="Tangira kuvuga">üéôÔ∏è</button>
                  <button id="sendBtn" class="cta">Ohereza</button>
                </div>

                <div style="display:flex;gap:8px;margin-top:8px">
                  <button id="imgGenBtn" class="toggle">Generate Image</button>
                  <div class="muted" style="margin-left:auto">Language: <select id="botLang"><option value="rw">Kinyarwanda</option><option value="sw">Kiswahili</option></select></div>
                </div>

              </div>

            </div>

            <!-- Right column: product quick view & map -->
            <div style="display:flex;flex-direction:column;gap:12px">
              <div class="card">
                <h4>Quick Product Finder</h4>
                <input id="quickFind" class="search" placeholder="Andika izina ry'igicuruzwa..." />
                <div id="quickResult" class="muted" style="margin-top:12px">Nta bisubizo</div>
                <button id="askStockBtn" class="cta" style="margin-top:8px">Saba Chatbot kureba stock</button>
              </div>

              <div class="card">
                <h4>Aho turi</h4>
                <div class="map" id="mapEmbed">
                  <!-- Google Maps iframe embed with provided coords -->
                  <iframe title="Gihosha Gisandema map" src="https://www.google.com/maps?q=-3.36392,29.378&z=15&output=embed" style="width:100%;height:100%;border:0" loading="lazy"></iframe>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <hr style="border:none;height:24px"/>

      <!-- CONTACT & WHATSAPP SUPPORT -->
      <section id="contact" class="reveal">
        <h2>Contact & Support</h2>
        <div class="grid" style="grid-template-columns:1fr 360px">
          <div class="card">
            <form id="contactForm" action="https://formsubmit.co/YOUR_EMAIL" method="POST">
              <!-- Prefill subject from CTA via JS -->
              <input type="hidden" name="_subject" id="prefillSubject" value="Gushaka igiciro" />
              <div style="display:flex;gap:8px;flex-direction:column">
                <label class="muted">Izina</label>
                <input name="name" required class="search" />
                <label class="muted">Email</label>
                <input name="email" type="email" required class="search" />
                <label class="muted">Ubutumwa</label>
                <textarea name="message" rows="5" required class="search"></textarea>
                <button class="cta" type="submit">Ohereza Ubutumwa</button>
              </div>
            </form>
          </div>
          <div class="card">
            <h4>WhatsApp Support</h4>
            <p class="muted">Twandikire kuri WhatsApp kuri numero yihuse:</p>
            <a id="waLink" class="cta" href="https://wa.me/25771633859?text=Muraho%20Boutique%20Smart%20-%20Ndashaka%20ubufasha" target="_blank" rel="noopener">Tangira WhatsApp</a>
            <div style="margin-top:12px" class="muted">Support: Maintenance, Orders, Returns</div>
          </div>
        </div>
      </section>

      <!-- Footer with contact info and QR code -->
      <footer class="reveal">
        <div class="card" style="display:flex;gap:12px;align-items:center;justify-content:space-between">
          <div>
            <div><strong>üìû +25771633859</strong> | üìß <strong>ornoirbruce5@gmail.com</strong></div>
            <div class="muted">üìç Gihosha Gisandema</div>
            <div style="margin-top:8px" class="socials">
              <a class="navlink" href="https://wa.me/25771633859">WhatsApp</a>
              <a class="navlink" href="https://instagram.com">Instagram</a>
              <a class="navlink" href="https://facebook.com">Facebook</a>
            </div>
          </div>

          <div style="display:flex;gap:12px;align-items:center">
            <div class="qr" id="qrContainer" title="QR code ya site">
              <!-- Minimal inline QR via data URL would be integrated by JS -->
              <canvas id="qrCanvas" width="80" height="80" aria-hidden="true"></canvas>
            </div>
            <div class="muted" style="font-size:13px">¬© Boutique Smart</div>
          </div>
        </div>
      </footer>

    </div>
  </main>

  <!-- Embedded JSON stock data and jokes -->
  <script>
    /* ========== Embedded data: stock.json (embedded) ========== */
    const STOCK_JSON = [
      {"id":"p1","name":"Robe Elegante","category":"imyenda","desc":"Robe yoroheje, ibara ryiza, sizes S-XL","price":"35,000 BIF","stock":12,"img":"https://images.unsplash.com/photo-1541099649105-f69ad21f3246?q=80&w=600&auto=format&fit=crop"},
      {"id":"p2","name":"Sneakers Sport","category":"inkweto","desc":"Inkweto zigezweho, zifite comfort","price":"45,000 BIF","stock":6,"img":"https://images.unsplash.com/photo-1519744792095-2f2205e87b6f?q=80&w=600&auto=format&fit=crop"},
      {"id":"p3","name":"Set ya Makeup","category":"ubwiza","desc":"Set y'ibanze ku bwiza, long-lasting","price":"20,000 BIF","stock":20,"img":"https://images.unsplash.com/photo-1522335789203-aabd1fc54bc9?q=80&w=600&auto=format&fit=crop"}
    ];

    /* jokes in Kirundi */
    const JOKES = [
      "Umuntu yabajije imbwa niba yakwiga; imbwa iramusubiza iti: 'Ndiga, ariko sinzi kwandika!'",
      "Umwana ati: 'Mama, ndota mfite amafaranga.' Mama aramubaza ati: 'Ese ni amafaranga y'ukuri?' Umwana ati: 'Oya, ni ayo kurya!'",
      "Umugabo agiye kugura ifarashi ariko yose ari 'out of stock'."
    ];
  </script>

  <!-- Main JS: Puter.js style chatbot, speech, stock search, jokes, theme, animations, QR -->
  <script>
    /* ============================
       Utility & Initialization
       - Theme toggle, reveal on scroll, smooth interactions
       ============================ */

    (function(){
      // Simple reveal on scroll
      const revealEls = document.querySelectorAll('.reveal');
      const io = new IntersectionObserver((entries)=>{
        entries.forEach(e=>{ if(e.isIntersecting) e.target.classList.add('active'); });
      }, {threshold:0.12});
      revealEls.forEach(el=>io.observe(el));

      // Theme toggle
      const themeToggle = document.getElementById('themeToggle');
      const root = document.documentElement;
      const savedTheme = localStorage.getItem('theme') || 'dark';
      root.setAttribute('data-theme', savedTheme);
      themeToggle.textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
      themeToggle.addEventListener('click',()=>{
        const t = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        root.setAttribute('data-theme', t); localStorage.setItem('theme', t);
        themeToggle.textContent = t === 'dark' ? 'üåô' : '‚òÄÔ∏è';
      });

      // Smooth scroll for internal links and CTA prefill
      document.querySelectorAll('a[href^="#"]').forEach(a=>{
        a.addEventListener('click', (ev)=>{
          ev.preventDefault();
          const href = a.getAttribute('href');
          const parts = href.split('?');
          const id = parts[0].slice(1);
          const params = new URLSearchParams(parts[1] || '');
          if(params.has('subject')) document.getElementById('prefillSubject').value = decodeURIComponent(params.get('subject'));
          const target = document.getElementById(id);
          if(target) target.scrollIntoView({behavior:'smooth'});
        });
      });
    })();

    /* ============================
       Stock: render table, live search, animated entry
       ============================ */
    (function(){
      const stockBody = document.getElementById('stockBody');
      const stockCount = document.getElementById('stockCount');
      const searchInput = document.getElementById('searchInput');
      const filterCat = document.getElementById('filterCat');

      function renderStock(list){
        stockBody.innerHTML = '';
        list.forEach((p, idx)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><img src="${p.img}" class="product-img" alt="${p.name}"></td>
            <td><strong>${p.name}</strong><div class="muted" style="font-size:13px">${p.desc}</div></td>
            <td><strong>${p.price}</strong></td>
            <td>${p.stock > 0 ? '‚úîÔ∏è' : '‚ùå'}</td>
          `;
          tr.style.opacity=0; tr.style.transform='translateY(10px)';
          stockBody.appendChild(tr);
          // animate entry staggered
          setTimeout(()=>{ tr.style.transition='all .45s cubic-bezier(.2,.9,.2,1)'; tr.style.opacity=1; tr.style.transform='none'; }, 80*idx);
        });
        stockCount.textContent = list.length;
      }

      function filterStock(){
        const q = searchInput.value.trim().toLowerCase();
        const cat = filterCat.value;
        const filtered = STOCK_JSON.filter(p=>{
          return (!cat || p.category===cat) && (p.name.toLowerCase().includes(q) || p.desc.toLowerCase().includes(q));
        });
        renderStock(filtered);
      }

      searchInput.addEventListener('input', filterStock);
      filterCat.addEventListener('change', filterStock);
      // initial render
      renderStock(STOCK_JSON);

      // Quick product finder uses the same stock data
      document.getElementById('quickFind').addEventListener('input', (e)=>{
        const q = e.target.value.trim().toLowerCase();
        const found = STOCK_JSON.find(p=>p.name.toLowerCase().includes(q) || p.desc.toLowerCase().includes(q));
        document.getElementById('quickResult').textContent = found ? `${found.name} ‚Äî ${found.price} (${found.stock} left)` : 'Nta bisubizo';
      });

      // askStockBtn triggers chat query to Puter
      document.getElementById('askStockBtn').addEventListener('click', ()=>{
        const q = document.getElementById('quickFind').value || 'Reba stock';
        Puter.handleUser(`Soma stock: ${q}`);
      });
    })();

    /* ============================
       Jokes: daily rotation, localStorage to avoid repeats
       ============================ */
    (function(){
      const jokeText = document.getElementById('jokeText');
      const newJokeBtn = document.getElementById('newJoke');
      const speakJokeBtn = document.getElementById('speakJoke');
      const usedKey = 'boutique_jokes_used';
      const used = JSON.parse(localStorage.getItem(usedKey) || '[]');

      function pickDaily(){
        // pick based on day index to have daily variety, but avoid repeats until cycle completes
        const day = new Date().toDateString();
        const stored = localStorage.getItem('boutique_joke_day');
        if(stored && JSON.parse(stored).day === day){
          const idx = JSON.parse(stored).idx;
          return idx;
        } else {
          const remaining = JOKES.map((j,i)=>i).filter(i=>!used.includes(i));
          if(!remaining.length){ localStorage.removeItem(usedKey); localStorage.setItem(usedKey, JSON.stringify([])); return Math.floor(Math.random()*JOKES.length); }
          const pick = remaining[Math.floor(Math.random()*remaining.length)];
          used.push(pick); localStorage.setItem(usedKey, JSON.stringify(used));
          localStorage.setItem('boutique_joke_day', JSON.stringify({day, idx:pick}));
          return pick;
        }
      }

      function showJoke(idx){
        jokeText.textContent = JOKES[idx];
        document.getElementById('jokeUsedCount').textContent = JSON.parse(localStorage.getItem(usedKey) || '[]').length;
      }

      const idx = pickDaily(); showJoke(idx);

      newJokeBtn.addEventListener('click', ()=>{
        // clear day to force new pick
        localStorage.removeItem('boutique_joke_day');
        const newIdx = pickDaily();
        showJoke(newIdx);
      });

      // speak in Kinyarwanda (or fallback voice)
      speakJokeBtn.addEventListener('click', ()=>{
        const s = new SpeechSynthesisUtterance(jokeText.textContent);
        // prefer Kinyarwanda-like voice (no official code), try sw or rw via voice selection
        const voices = speechSynthesis.getVoices();
        const pick = voices.find(v=>/sw|kiswahili|kiswahili|kisw/i.test(v.lang)) || voices.find(v=>/fr|fr-FR/i.test(v.lang)) || voices[0];
        if(pick) s.voice = pick;
        s.lang = pick ? pick.lang : 'rw-RW';
        speechSynthesis.speak(s);
      });
    })();

    /* ============================
       Simple QR generation (canvas) for footer
       ============================ */
    (function(){
      const canvas = document.getElementById('qrCanvas');
      const ctx = canvas.getContext('2d');
      // minimal visual QR placeholder (not real scannable); draws logo-like pattern
      ctx.fillStyle = '#e6eef6';
      ctx.fillRect(0,0,80,80);
      ctx.fillStyle = '#071226';
      for(let i=0;i<6;i++){
        for(let j=0;j<6;j++){
          if(Math.random()>0.6) ctx.fillRect(4+i*12,4+j*12,8,8);
        }
      }
    })();

    /* ============================
       PUTER.JS STYLE CHATBOT
       - Lightweight local engine emulating Puter.js features:
         * handles text and voice input
         * simple "intelligent" routing: product lookup, greeting, jokes, image gen request
         * uses Web Speech API for recognition and synthesis
         * inserts emojis based on sentiment keywords
         * can "generate image" via placeholder flow (puter.ai.txt2img simulated)
       ============================ */

    const Puter = (function(){
      // internal chat state
      const chatWindow = document.getElementById('chatWindow');
      const input = document.getElementById('chatInput');
      const sendBtn = document.getElementById('sendBtn');
      const voiceBtn = document.getElementById('voiceBtn');
      const imgGenBtn = document.getElementById('imgGenBtn');
      const botLangSelect = document.getElementById('botLang');

      // basic emoji injection rules
      const EMOJI_MAP = [
        {words:['urakoze','murakoze','thanks','thank'], emo:'üôè'},
        {words:['neza','nziza','üòç','like','love'], emo:'‚ù§Ô∏è'},
        {words:['hate','bad','nta','not'], emo:'üòï'},
        {words:['haha','hahaha','joke','jokes'], emo:'üòÇ'},
        {words:['sale','giciro','discount','offer'], emo:'üî•'}
      ];

      // helper to add message
      function addMessage(text, who='bot'){
        const el = document.createElement('div');
        el.className = 'message ' + (who==='user' ? 'user-msg' : 'bot-msg');
        el.innerHTML = text;
        chatWindow.appendChild(el);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      // simple sentiment/emoji function
      function emojisFor(text){
        const t = text.toLowerCase();
        const found = EMOJI_MAP.filter(m=>m.words.some(w=>t.includes(w)));
        return found.length ? ' ' + found.map(f=>f.emo).join('') : '';
      }

      // simple text "intelligence" rules: product query, stock check, jokes, greetings, image requests
      function generateReply(text){
        const t = text.toLowerCase();
        // product lookup intent
        if(/stock|ibicuruzwa|biriho|bihari|reba stock|soma stock|have|in stock|igicuruzwa/.test(t)){
          const name = text.split(':')[1] ? text.split(':')[1].trim() : text;
          const found = STOCK_JSON.find(p => p.name.toLowerCase().includes(name.toLowerCase()) || p.desc.toLowerCase().includes(name.toLowerCase()));
          if(found){
            return `Turi dufite <strong>${found.name}</strong> ‚Äî ${found.price} üõçÔ∏è${found.stock>0 ? ' (hari muri stock)' : ' (nta stock)'}${emojisFor(text)}`;
          } else {
            // fuzzy search
            const possible = STOCK_JSON.filter(p=>p.name.toLowerCase().includes(name.toLowerCase()) || p.desc.toLowerCase().includes(name.toLowerCase()));
            if(possible.length) return `Habonetse amahitamo: ${possible.map(p=>p.name).join(', ')}. ${emojisFor(text)}`;
            return `Ndabona tutabifite neza, wampa izina ryuzuye cyangwa usabe gufata urugero, turagufasha ‚ú®`;
          }
        }
        // image generation intent
        if(/image|draw|shushanya|generate|gushushanya|amafoto|foto/.test(t)){
          return {type:'image', prompt: text};
        }
        // joke
        if(/joke|jokes|urwenya|guseka|vuga joke/.test(t)){
          const idx = Math.floor(Math.random()*JOKES.length);
          return `Urwenya: ${JOKES[idx]} ${emojisFor(text)}`;
        }
        // greeting
        if(/muraho|hello|hi|mwaramutse|bonsoir|bonsoir|salama|habari/.test(t)){
          return `Muraho! Nishimiye kugufasha üòä${emojisFor(text)}`;
        }
        // price or offer
        if(/price|giciro|cost|igiciro/.test(t)){
          // return list of matches
          const matches = STOCK_JSON.map(p=>`${p.name}: ${p.price}`).join(' ¬∑ ');
          return `Dore bimwe mu biciro: ${matches} ${emojisFor(text)}`;
        }
        // fallback: friendly assistant reply (simulated LLM)
        return `Ndagufasha: ${text}. Niba ushaka ibicuruzwa, andika izina ry'igicuruzwa cyangwa kanda "Saba Chatbot kureba stock". ${emojisFor(text)}`;
      }

      // text-to-speech function using selected language preference
      function speakText(txt, langCode){
        const utter = new SpeechSynthesisUtterance(txt);
        // choose voice by language preference or fallback
        const voices = speechSynthesis.getVoices();
        let pref = null;
        if(langCode === 'rw'){ // Kinyarwanda: try Swahili or French fallback
          pref = voices.find(v=>/rw|kinyarwanda/i.test(v.lang)) || voices.find(v=>/sw|kiswahili/i.test(v.lang)) || voices.find(v=>/fr/i.test(v.lang)) || voices[0];
        } else if(langCode === 'sw'){
          pref = voices.find(v=>/sw|kiswahili/i.test(v.lang)) || voices.find(v=>/en/i.test(v.lang)) || voices[0];
        } else {
          pref = voices.find(v=>v.lang.startsWith(langCode)) || voices[0];
        }
        if(pref) utter.voice = pref;
        utter.lang = pref ? pref.lang : (langCode === 'rw' ? 'rw-RW' : (langCode === 'sw' ? 'sw-KE' : langCode));
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
      }

      // simulated image generation "puter.ai.txt2img" placeholder
      function generateImage(prompt){
        // show interim bot message then replace with generated image
        addMessage(`<div>Ndimo gushinga ifoto: <em>${prompt}</em> ‚è≥</div>`);
        setTimeout(()=>{
          // create simple data card with placeholder image from unsplash with query
          const q = encodeURIComponent(prompt.split(' ').slice(0,5).join(' '));
          const url = `https://source.unsplash.com/400x300/?${q}`;
          addMessage(`<div><img src="${url}" alt="${prompt}" style="width:100%;border-radius:8px"/><div class="muted" style="margin-top:6px">Ifoto yashushanyijwe hashingiwe kuri: "${prompt}"</div></div>`);
        }, 1200);
      }

      /* ================
         Public handlers
         ================ */

      function handleUser(text){
        if(!text) return;
        addMessage(text, 'user');
        // generate reply
        const reply = generateReply(text);
        // if reply indicates image generation
        if(typeof reply === 'object' && reply.type === 'image'){
          // simulate image generation and TTS
          setTimeout(()=>{ generateImage(reply.prompt); speakText('Nakoze ifoto yawe', botLangSelect.value); }, 600);
          addMessage(`<div class="muted">Ibyifuzo byo gushushanya byakiriwe üé®</div>`);
          return;
        }
        // plain text reply
        setTimeout(()=>{
          addMessage(reply);
          // TTS in selected language (Kinyarwanda or Kiswahili)
          const lang = botLangSelect.value;
          speakText(stripHtml(reply), lang);
        }, 600);
      }

      // simple html stripper
      function stripHtml(html){
        const tmp = document.createElement('div'); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || '';
      }

      // wire up UI controls
      sendBtn.addEventListener('click', ()=>{ const v = input.value.trim(); if(!v) return; handleUser(v); input.value=''; });
      input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }});
      imgGenBtn.addEventListener('click', ()=>{ const p = input.value.trim() || prompt('Sobanura ifoto wifuza (mu Kinyarwanda cyangwa Kiswahili)'); if(p) handleUser('generate image: ' + p); });

      // voice recognition
      let recognition = null;
      function initRecognition(){
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!SpeechRecognition) return null;
        const r = new SpeechRecognition();
        r.continuous = false; r.interimResults = false;
        // try to set language to Kinyarwanda-like (rw) or Swahili for recognition
        r.lang = 'rw-RW';
        r.onresult = (ev)=>{
          const t = ev.results[0][0].transcript;
          input.value = t;
          handleUser(t);
        };
        r.onerror = (ev)=>{ console.warn('Recognition error', ev); };
        return r;
      }

      voiceBtn.addEventListener('click', ()=>{
        if(!recognition) recognition = initRecognition();
        if(!recognition){ alert('Icyuma cyo kumva ivuga ntabwo kiboneka kuri browser yawe'); return; }
        try{
          recognition.start();
        } catch(e){
          // already started; stop
          recognition.stop();
        }
      });

      // expose quick entry for other modules
      return { handleUser };
    })();

    // Expose Puter globally for quick access by other UI buttons
    window.Puter = Puter;

    /* ============================
       Auto-play audio greeting in French on user gesture
       - We'll synthesize a short greeting via TTS in French and play it once after an interaction
       ============================ */
    (function(){
      const greetingText = 'Bonjour et bienvenue chez Boutique Smart. Nous sommes pr√™ts √† vous aider.';
      const greet = ()=>{
        const u = new SpeechSynthesisUtterance(greetingText);
        const v = speechSynthesis.getVoices().find(x=>/fr|fr-FR/i.test(x.lang)) || speechSynthesis.getVoices()[0];
        if(v) u.voice = v;
        u.lang = v ? v.lang : 'fr-FR';
        speechSynthesis.speak(u);
        document.removeEventListener('click', greet);
      };
      // wait for any click to deliver greeting (avoids autoplay block)
      document.addEventListener('click', greet, {once:true});
    })();

    /* ============================
       Accessibility: focus chat when open
       ============================ */
    document.getElementById('openChat').addEventListener('click', ()=>{
      document.getElementById('chat').scrollIntoView({behavior:'smooth'});
      setTimeout(()=>document.getElementById('chatInput').focus(),600);
    });

    /* ============================
       WhatsApp autoresponder link already in place; ensure message param is encoded
       ============================ */
    (function(){
      const wa = document.getElementById('waLink');
      const defaultMsg = encodeURIComponent('Muraho Boutique Smart, ndashaka ubufasha kuri order.');
      wa.href = `https://wa.me/25771633859?text=${defaultMsg}`;
    })();

    /* ============================
       Contact form: uses FormSubmit.io (replace YOUR_EMAIL in form action)
       ============================ */
    (function(){
      const form = document.getElementById('contactForm');
      form.addEventListener('submit', (e)=>{
        // allow normal POST to formsubmit; we can add a little UX change before submit
        const btn = form.querySelector('button[type="submit"]');
        btn.disabled = true; btn.textContent = 'Ohereza...';
        setTimeout(()=>{ btn.disabled=false; btn.textContent='Ohereza Ubutumwa'; }, 3000);
      });
    })();

    /* ============================
       Small helper: parse URL params for prefilled subject if page opened with ?subject=
       ============================ */
    (function(){
      const params = new URLSearchParams(window.location.search);
      if(params.get('subject')) document.getElementById('prefillSubject').value = params.get('subject');
    })();

    /* ============================
       End of script
       ============================ */
  </script>
</body>
</html>
